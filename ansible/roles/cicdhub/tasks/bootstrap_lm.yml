- name: Create Bootstrap LM Directory
  file:
    path: "/tmp/bootstrap_lm"
    state: directory

- name: Copy LM Docker Source Package
  copy:
    src: "{{bootstrap_lm_docker_source_path}}"
    dest: "/tmp/bootstrap_lm"

- name: Determine Docker Source package filename
  set_fact:
    bootstrap_lm_docker_source_tar_name: "{{bootstrap_lm_docker_source_path | basename}}"
    bootstrap_lm_docker_source_inner_dir: "{{(bootstrap_lm_docker_source_path | basename | splitext)[0] | replace('-dist','')}}"

- name: Extract LM Docker Source Package
  unarchive:
    remote_src: yes
    src: "/tmp/bootstrap_lm/{{bootstrap_lm_docker_source_tar_name}}" 
    dest: "/tmp/bootstrap_lm"

- name: Read Docker Compose
  slurp:
    src: "/tmp/bootstrap_lm/{{ bootstrap_lm_docker_source_inner_dir }}/docker-compose.yml"
  register: docker_compose

- name: Update Docker Compose with registry uri
  update_docker_compose:
    docker_compose: "{{ docker_compose['content'] | b64decode | from_yaml }}"
    docker_registry_uri: "{{cicdhub_addr_docker_registry_host}}:{{cicdhub_addr_docker_registry_port}}"
    path: "/tmp/bootstrap_lm/{{ bootstrap_lm_docker_source_inner_dir }}/docker-compose.yml"
  register: docker_compose_final

- name: Create Docker Compose
  copy: content="{{ docker_compose_final.result }}" dest="/tmp/bootstrap_lm/{{ bootstrap_lm_docker_source_inner_dir }}/docker-compose.yml"

- name: Build Docker Images
  shell: "docker-compose -f /tmp/bootstrap_lm/{{ bootstrap_lm_docker_source_inner_dir }}/docker-compose.yml build"

- name: Push Docker Images to Docker Registry
  shell: "docker-compose -f /tmp/bootstrap_lm/{{ bootstrap_lm_docker_source_inner_dir }}/docker-compose.yml push"

- name: Copy LM Helm Charts Package
  copy:
    src: "{{bootstrap_lm_helm_charts_path}}"
    dest: "/tmp/bootstrap_lm"
    
- name: Push Helm Charts package to Nexus
  shell: curl -v -u admin:admin123 --upload-file /tmp/bootstrap_lm/{{bootstrap_lm_helm_charts_path | basename }} {{ cicdhub_addr_nexus }}/repository/raw/lm-helm-charts/